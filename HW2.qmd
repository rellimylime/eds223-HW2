---
title: "Homework Assignment #2: Exploring patterns of environmental justice:"
format: pdf
editor: source
editor_options: 
  chunk_output_type: inline
---

## Load necessary libraries and data

```{r}
#| echo: true
#| message: false
#| results: 'hide'


# Load libraries
library(sf)
library(tmap)
library(tidyverse)
library(spData)
library(knitr)
library(viridis)
library(testthat)

# Load necessary data
ejscreen <- sf::st_read(here::here("data", "ejscreen","EJSCREEN_2023_BG_StatePct_with_AS_CNMI_GU_VI.gdb")) 

birds <- sf::st_read(here::here("data", "gbif-birds-LA","gbif-birds-LA.shp")) 

ineq <- sf::st_read(here::here("data", "mapping-inequality", "mapping-inequality-los-angeles.json"))
```

## Check data CRS

```{r}
# Return ejscreen crs
st_crs(ejscreen)
```

```{r}
# Return birds crs
st_crs(birds)
```

```{r}
# Return ineq crs
st_crs(ineq)
```

We can see that the ejscreen data is in EPSG:3857, the common projected coordinate system, whereas the other two are in EPSG:4326 which is the common geodetic coordinate system. We can transform the other files' crs to match the ejscreen crs.

```{r}
# Transform birds crs to match ejscreen
birds <- st_transform(birds, crs = st_crs(ejscreen))

# Transform ineq crs to match ejscreen
ineq <- st_transform(ineq, crs = st_crs(ejscreen))

# Check that all CRS match
if(!st_crs(ineq) == st_crs(birds)) {
  stop("ERROR: CRS of ineq and birds do not match after transformation!")
}

if(!st_crs(ejscreen) == st_crs(ineq)) {
  stop("ERROR: CRS of ejscreen and ineq do not match after transformation!")
}

# Success message
message("All datasets have matching CRS: ", st_crs(ejscreen)$input)
```

## Part 1: Legacy of redlining in current environmental (in)justice

1.  Create map of historical redlining neighborhoods, including:

-   neighborhoods colored by HOLC grade
-   an appropriate base map
-   a clear title and legend

```{r}
# filter to California
california <- ejscreen %>%
  dplyr::filter(ST_ABBREV == "CA") 

# filter to Los Angeles County
la_county <- ejscreen %>%
  dplyr::filter(CNTY_NAME %in% c("Los Angeles County"))
```

```{r}
# Make the map
tm_basemap("Esri.OceanBasemap") + # Ocean basemap
tm_shape(california, bbox = ineq) + # Get census block grids
  tm_borders(col = "gray70",
             lwd = 0.3) +
tm_shape(ineq) + # HOLC Graded areas
  tm_polygons(fill = "grade", 
              fill.scale = tm_scale_categorical(values = "viridis"),
              fill.legend = tm_legend(title = "HOLC Grade", frame = FALSE),
              col = "gray30",
              lwd = 0.2) +
tm_scalebar(position = c("right", "bottom")) +
tm_compass(position = c("right", "top")) +
tm_title(text = "Home Owners' Loan Corporation (HOLC)\nHistorical Redlining Neighborhoods in Los Angeles County") 
```

2.  Create a table summarizing:

-   the percentage of census block groups that fall within each HOLC grade
-   Also include the percent of census block groups that dont fall within a HOLC grade \_ **Hint:** The HOLC data contains the grades and the EJScreen data contains the census blocks, so you will need to combine the data spatially before doing summary statistics. Once you combine and no longer need the geometries, you can use st_drop_geometry().

```{r}
# Perform spatial join 
block_grades <- st_join(la_county, ineq, join = st_intersects)

# Drop geometries after join
block_grades_df <- st_drop_geometry(block_grades)
```

```{r}
# Create a df containing the percent of census block groups that fall within each HOLC grade
grade_summary <- block_grades_df %>% 
  group_by(grade) %>% 
  summarize(total_blocks = n()) %>% 
  mutate(percent = (total_blocks / nrow(block_grades_df)) * 100)

# Verify percentages sum to 100%
total_percent <- sum(grade_summary$percent)
if(abs(total_percent - 100) > 0.01) {
  warning("WARNING: Percentages sum to ", round(total_percent, 2), "%, not 100%")
} else {
  message("Percentage sum to 100%")
}
```

```{r}
# Create kable table
grade_summary %>%
  mutate(percent = paste0(round(percent, 2), '%')) %>%
  kable(col.names = c("HOLC Grade", "Number of Block Groups", "Percentage"),
        caption = "Distribution of Census Block Groups by HOLC Grade in Los Angeles County",
        format.args = list(big.mark = ","),
        align = "ccc"
) 
```

3.  Create at least two visualizations summarizing current conditions (from the EJScreen data) within HOLC grades using the mean of the following variables (you may combine variables or create separate plots):

-   \% low income
-   percentile for Particulate Matter 2.5
-   percentile for low life expectancy
-   Use ggplot for your visualizations! You will first need to calculate mean of each variable grouped by HOLC grade.

```{r}
# Save data summary containing the means of each value by HOLC Grade
grade_summary_plot <- block_grades_df %>% 
  group_by(grade) %>% 
  summarize(total_blocks = n(),
            percent = total_blocks / nrow(block_grades_df),
            mean_lowincome = mean(LOWINCPCT * 100),
            mean_part = mean(P_PM25),
            mean_lifeexp = mean(P_LIFEEXPPCT, na.rm = TRUE))

# Verify we have data for all grades
message(paste("Calculated means for", nrow(grade_summary_plot), "categories including NA"))

```

```{r}
# Remove NA grade
grade_summary_plot_graded <- grade_summary_plot %>%
  filter(!is.na(grade))

# Verify removal
if(nrow(grade_summary_plot_graded) != 4) {
  warning("Expected 4 HOLC grades (A, B, C, D), but found ", 
          nrow(grade_summary_plot_graded))
}
```

```{r}
# Plot Low Income vs PM2.5
ggplot(grade_summary_plot_graded, aes(x = mean_lowincome, y = mean_part, color = grade)) +
  geom_point(size = 4, shape = 15) +
  scale_color_viridis_d(option = "viridis") +
  labs(
    title = "Particulate Matter 2.5 and Income\n by HOLC Grade",
    x = "Mean Percentage of\n Low Income Residents (%)", 
    y = "Mean Percentile for\n Particulate Matter 2.5",
    color = "HOLC Grade"
  ) +
  theme_minimal()
```

```{r}
# Plot Low Income vs Life Expectancy
ggplot(grade_summary_plot_graded, aes(x = mean_lowincome, y = mean_lifeexp, color = grade)) +
  geom_point(size = 4) +
  scale_color_viridis_d(option = "viridis") +
  labs(
    title = "Life Expectancy and Income \nby HOLC Grade",
    x = "Mean Percentage of \nLow Income Residents (%)", 
    y = "Mean Percentile for \nLow Life Expectancy",
    color = "HOLC Grade"
  ) +
  theme_minimal() 
```

```{r}
# Reshape data for final comparison
grade_comparison <- grade_summary_plot_graded %>%
  select(grade, mean_lowincome, mean_part, mean_lifeexp) %>%
  rename("Low Income (%)" = mean_lowincome, 
         "PM2.5 Exposure\n(Percentile)" = mean_part,
         "Low Life Expectancy\n(Percentile)" = mean_lifeexp) %>% 
  pivot_longer(cols = c(`Low Income (%)`, 
                        `PM2.5 Exposure\n(Percentile)`, 
                        `Low Life Expectancy\n(Percentile)`),
               names_to = "indicator",
               values_to = "value")
  

# Create faceted bar chart
ggplot(grade_comparison, aes(x = grade, y = value, fill = grade)) +
  geom_col(show.legend = TRUE) +
  scale_fill_viridis_d(option = "viridis") +
  facet_wrap(~indicator, scales = "free_y", nrow = 1) +
  labs(
    title = "Environmental Justice Indicators Across Historical HOLC Grades",
    x = "HOLC Grade",
    y = "Mean Value",
    fill = "HOLC Grade"
  ) +
  theme_minimal() 
```

4.  Write a brief paragraph reflecting on these results

-   Interpret the patterns you observe in your results
-   Discuss potential relationships between historical redlining grades and current environmental/socioeconomic conditions

These visualizations reveal a clear connection between historical HOLC grades and current environmental and socioeconomic conditions in Los Angeles County. Neighborhoods with lower HOLC grades (C and D) consistently show higher percentages of low-income residents and worse environmental health indicators. Grade D neighborhoods, which were historically redlined, have the highest rates of low-income residents at approximately 40%, compared to only 15% in Grade A neighborhoods. Similar disparities exist for environmental health measures: Grade D neighborhoods face higher exposure to particulate matter (80th percentile) and lower life expectancy (54th percentile), while Grade A neighborhoods experience better conditions with PM2.5 at the 72nd percentile and low life expectancy at only the 24th percentile. These patterns demonstrate how discriminatory housing policies from nearly 90 years ago continue to shape present-day environmental injustices, with historically redlined communities still bearing disproportionate burdens of poverty, pollution, and reduced life expectancy.

## 2. Legacy of redlining in biodiversity observations

For this assignment, you must produce the following based on observations from 2021-2023:

1.  A figure summarizing the percent of observations within redlined neighborhoods within each HOLC grade

    Create a visualizations that shows:

    -   The percentage of bird observations within each HOLC grade

    -   Include an appropiate title, axis labels, and legend

    -   **Hints**: Ensure the bird observations and HOLC dataset have matching CRS’, then perform a spatial join to assign each bird observations to a corresponding HOLC grade.

```{r}
# Combine all the geometries in each HOLC grade for easier joining, remove na values
ineq_union <- ineq %>% 
  filter(!is.na(grade)) %>% 
  group_by(grade) %>% 
  summarise(geometry = st_union(geometry))
```

```{r}
# Verify CRS before joining
if(!st_crs(birds) == st_crs(ineq_union)) {
  stop("ERROR: CRS mismatch between birds and ineq_union!")
}
```

```{r}
# Join the bird observations with the combined HOLC data
obs_per_grade <- st_join(birds, ineq_union, left = FALSE)

# Define the total using the number of rows in the joined df
total <- nrow(obs_per_grade)

# Calculate the portion of bird observations within each holc grade
portion_obs <- obs_per_grade %>% 
  group_by(grade) %>% 
  summarize(portion_obs = 100 * n() / total)
```

```{r}
# Create visualization to show percentage of bird observations within each HOLC grade
ggplot(portion_obs, aes(x = grade, y= portion_obs, fill = grade)) +
  geom_col(show.legend = FALSE) +
    scale_fill_viridis_d(option = "viridis") +
  labs(title = "Percentage of Bird Observations within HOLC Grades",
       x = "HOLC Grade",
       y = "Percentage of Observations (%)",
       fill = "HOLC Grade") +
  theme_minimal()
```

2.  **Spolier alert!!** Our results don’t match the findings from Ellis-Soto et al. 2023! Read the [abstract](https://ecoevorxiv.org/repository/view/3736/) of the study. Why might we have obtained different results in our analysis? What did the paper consider that we did not?

The most significant difference in our analysis is likely the scope and scale. The Ellis-Soto study examined 195 metropolitan areas across 38 states, whereas we limited our data to just Los Angeles County, California. This broader geographic scope allowed Ellis-Soto et al. to identify consistent patterns across diverse urban contexts. Additionally, the Ellis-Soto study accounted for confounding variables that could influence bird observation patterns by considering factors such as present-day vegetation cover, open space availability, population density, and climate differences between neighborhoods. After accounting for these factors, they still found significantly lower sampling density and completeness in historically redlined neighborhoods compared to areas designated as "desirable." Our analysis did not control for these environmental and demographic variables, which means we cannot account for differences in observation patterns; e.g. whether are due to persisting effects of redlining itself or due to present-day environmental conditions that may make some areas more conducive to bird observation.
